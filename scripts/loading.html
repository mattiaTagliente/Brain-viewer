<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="color-scheme" content="dark">
<title>Brain Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; background: #000; }
  canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 2; pointer-events: none; transition: opacity 0.6s ease;
  }
  .overlay {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 3; pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .overlay.fade-out { opacity: 0; }
  canvas.fade-out { opacity: 0; }
  h1 {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    font-size: 2.4rem; font-weight: 300; letter-spacing: 0.3em;
    color: #00ccff;
    text-shadow: 0 0 30px rgba(0,204,255,0.5), 0 0 60px rgba(0,204,255,0.2);
    margin-bottom: 2rem;
  }
  .status {
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-size: 0.85rem; color: rgba(255,255,255,0.45);
    letter-spacing: 0.15em; text-transform: lowercase;
  }
  .dots { display: inline-flex; gap: 6px; margin-top: 1.5rem; }
  .dots span {
    width: 5px; height: 5px; border-radius: 50%;
    background: #00ccff; opacity: 0.3;
    animation: pulse 1.4s ease-in-out infinite;
  }
  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.5); }
  }
</style>
</head>
<body>
<canvas id="bg"></canvas>
<div class="overlay" id="overlay">
  <h1>BRAIN VIEWER</h1>
  <div class="status" id="status">starting servers</div>
  <div class="dots"><span></span><span></span><span></span></div>
</div>
<script>
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
const overlayEl = document.getElementById('overlay');
const statusEl = document.getElementById('status');
const colors = ['#00ccff','#ff6600','#9966ff','#00ff88','#ffcc00','#ff3366','#33cccc'];
const nodes = [];
const NODE_COUNT = 30;
const CONNECT_DIST = 140;
let appMounted = false;
let appReady = false;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

for (let i = 0; i < NODE_COUNT; i++) {
  nodes.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    vx: (Math.random() - 0.5) * 0.3,
    vy: (Math.random() - 0.5) * 0.3,
    r: 2 + Math.random() * 2.5,
    color: colors[i % colors.length],
    phase: Math.random() * Math.PI * 2
  });
}

function hexRgb(hex) {
  return [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
}

let t = 0;
function draw() {
  t += 0.008;
  ctx.fillStyle = 'rgba(0,0,0,0.12)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  for (let i = 0; i < nodes.length; i++) {
    const a = nodes[i];
    a.x += a.vx; a.y += a.vy;
    if (a.x < 0 || a.x > canvas.width) a.vx *= -1;
    if (a.y < 0 || a.y > canvas.height) a.vy *= -1;

    for (let j = i + 1; j < nodes.length; j++) {
      const b = nodes[j];
      const dx = a.x - b.x, dy = a.y - b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < CONNECT_DIST) {
        ctx.strokeStyle = `rgba(34,68,170,${(1 - dist/CONNECT_DIST) * 0.15})`;
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
      }
    }

    const p = 0.5 + 0.5 * Math.sin(t * 2 + a.phase);
    const [r,g,b] = hexRgb(a.color);
    const glow = ctx.createRadialGradient(a.x, a.y, 0, a.x, a.y, a.r * 4);
    glow.addColorStop(0, `rgba(${r},${g},${b},${0.25 * p})`);
    glow.addColorStop(1, 'transparent');
    ctx.fillStyle = glow;
    ctx.fillRect(a.x - a.r*4, a.y - a.r*4, a.r*8, a.r*8);

    ctx.fillStyle = `rgba(${r},${g},${b},${0.5 + 0.5*p})`;
    ctx.beginPath(); ctx.arc(a.x, a.y, a.r, 0, Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();

function setStatus(text) {
  statusEl.textContent = text;
}

function hideSplash() {
  if (appReady) return;
  appReady = true;
  overlayEl.classList.add('fade-out');
  canvas.classList.add('fade-out');
  setTimeout(() => {
    overlayEl.style.display = 'none';
    canvas.style.display = 'none';
  }, 650);
}

function mountAppFrame() {
  if (appMounted) return;
  appMounted = true;
  setStatus('loading app');

  const frame = document.createElement('iframe');
  frame.id = 'app-frame';
  frame.title = 'Brain Viewer App';
  frame.src = 'http://localhost:5174/';
  frame.style.position = 'fixed';
  frame.style.inset = '0';
  frame.style.width = '100%';
  frame.style.height = '100%';
  frame.style.border = '0';
  frame.style.background = '#000';
  frame.style.zIndex = '1';
  frame.style.opacity = '1';

  frame.onload = () => {
    if (!appReady) setStatus('loading graph data');
  };

  document.body.appendChild(frame);

  // Fallback: never keep splash forever if ready signal is missed.
  setTimeout(() => {
    if (!appReady) {
      setStatus('finalizing');
      hideSplash();
    }
  }, 20000);
}

window.addEventListener('message', (event) => {
  const data = event.data;
  if (!data || typeof data !== 'object') return;
  if (data.type === 'brain-viewer-status' && typeof data.status === 'string') {
    setStatus(data.status);
    return;
  }
  if (data.type === 'brain-viewer-ready') {
    setStatus('ready');
    hideSplash();
    return;
  }
  if (data.type === 'brain-viewer-error') {
    setStatus('startup error');
    return;
  }
});

// Poll Vite dev server until it responds, then mount app in iframe.
let attempts = 0;

function checkServer() {
  attempts++;
  if (attempts > 6) setStatus('almost ready');
  const img = new Image();
  img.onload = () => {
    mountAppFrame();
  };
  img.onerror = () => setTimeout(checkServer, 700);
  img.src = 'http://localhost:5174/vite.svg?' + Date.now();
}
checkServer();
</script>
</body>
</html>
